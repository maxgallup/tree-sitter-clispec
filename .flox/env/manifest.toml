version = 1

[install]
libclang.pkg-path = "libclang"
rustup.pkg-path = "rustup"
pkg-config.pkg-path = "pkg-config"
openssl.pkg-path = "openssl"
just.pkg-path = "just"
libiconv.pkg-path = "libiconv"
libiconv.systems = ["aarch64-darwin", "x86_64-darwin"]


[vars]
# This makes cargo installation local to the flox environment
CARGO_HOME = "$FLOX_ENV_PROJECT/.flox/cache/cargo"
RUSTUP_HOME = "$FLOX_ENV_PROJECT/.flox/cache/rustup"
PATH = "$CARGO_HOME/bin:$PATH"
CC = "gcc" # Need this for successful static builds
CC_aarch64_unknown_linux_musl = "gcc"
AR_aarch64_unknown_linux_musl = "ar"


[hook]
on-activate = '''
  # Rust/OpenSSL build configuration
  export PKG_CONFIG_PATH="${PKG_CONFIG_PATH:+$PKG_CONFIG_PATH:}$FLOX_ENV/lib/pkgconfig"
  export OPENSSL_DIR="$FLOX_ENV"

  # Fix for cargo issues with LD_AUDIT on flox (https://github.com/flox/flox/issues/1341#issuecomment-2067207817)
  unset LD_AUDIT

  # Install stable toolchain if not present
  if [ ! -d "$RUSTUP_HOME/toolchains" ]; then
    echo "Installing stable toolchain to project directory..."
    rustup toolchain install stable
    rustup default stable
    echo "âœ“ Stable toolchain installed"
  fi

  # Add musl targets for static builds
  if ! rustup target list --installed | grep -q "aarch64-unknown-linux-musl"; then
    rustup target add aarch64-unknown-linux-musl
    rustup target add x86_64-unknown-linux-musl
  fi

  cargo install tree-sitter-cli --locked

  echo "Just run 'just' to get started!"
  echo ""
'''

[profile]
[services]
[include]
[build]
[options]
